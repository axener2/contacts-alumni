<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sutams Alumni Directory</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <style>
    body {font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f6f8;}
    .container {max-width: 1000px; margin: 0 auto; padding: 20px; position: relative;}
    .pageTitle {text-align: center; margin: 40px 0 20px; font-size: 26px; font-weight: 700;}
    .card {background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin: 0 auto; max-width: 420px;}
    .card h2 {margin-top: 0;}
    input[type="email"] {width: 100%; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #ccc;}
    .btn {background: #28a745; color: #fff; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;}
    .btn:hover {background: #218838;}
    .pill {background: #e9ecef; padding: 5px 10px; border-radius: 20px; margin-right: 10px;}
    .topRight {position: absolute; top: 20px; right: 20px;}
    .hide {display: none;}
    table {width: 100%; margin-top: 20px; border-collapse: collapse;}
    th, td {padding: 8px; border: 1px solid #ddd; text-align: left;}
  </style>
</head>
<body>
  <div class="container">

    <h1 class="pageTitle">Sutams Alumni Directory</h1>

    <!-- User info & logout -->
    <div id="userBox" class="hide topRight">
      <span id="who" class="pill"></span>
      <button id="logoutBtn" class="btn">Log out</button>
    </div>

    <!-- Login card -->
    <section id="loginCard" class="card login">
      <h2>Sign in</h2>
      <p>Enter your email to receive a <b>login link</b>. Only allow-listed alumni can access.</p>
      <input type="email" id="email" placeholder="you@example.com" autocomplete="email">
      <label><input type="checkbox" id="rememberMe" checked> Remember this device (14 days max)</label><br><br>
      <button id="loginBtn" class="btn">Send login link</button>
      <p style="font-size:12px;color:#555;margin-top:10px;">Tip: keep this tab open; click the link in your email. You’ll return here and be signed in.</p>
    </section>

    <!-- Protected directory -->
    <section id="app" class="hide">
      <table id="contacts" class="display"></table>
    </section>
  </div>

  <!-- Firebase + libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /* ====== Firebase config ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyAwj6GtC65Q8-xCa3BCLwxGJ8vUArOAHUY",
      authDomain: "sutams-alumni.firebaseapp.com",
      projectId: "sutams-alumni",
      storageBucket: "sutams-alumni.firebasestorage.app",
      messagingSenderId: "817072662829",
      appId: "1:817072662829:web:0ecf3be2338326fb37cba4",
      measurementId: "G-6T86CT10TP"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* DOM */
    const loginCard = document.getElementById('loginCard');
    const appSection = document.getElementById('app');
    const loginBtn = document.getElementById('loginBtn');
    const emailInput = document.getElementById('email');
    const who = document.getElementById('who');
    const userBox = document.getElementById('userBox');
    const logoutBtn = document.getElementById('logoutBtn');

    /* Session */
    const SESSION_LIMIT_MS = 14*24*60*60*1000;
    const sessKey = 'sessStart';
    const now = () => Date.now();

    /* Email link login */
    loginBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim().toLowerCase();
      if (!email) return alert("Enter your email");

      const url = new URL(window.location.href);
      url.searchParams.set('e', email);

      const actionCodeSettings = { url: url.toString(), handleCodeInApp: true };
      try {
        await auth.sendSignInLinkToEmail(email, actionCodeSettings);
        window.localStorage.setItem('emailForSignIn', email);
        alert("Login link sent to " + email);
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    if (auth.isSignInWithEmailLink(window.location.href)) {
      let email = window.localStorage.getItem('emailForSignIn');
      if (!email) {
        const params = new URL(window.location.href).searchParams;
        email = (params.get('e') || "").trim().toLowerCase();
      }
      if (!email) email = window.prompt("Confirm your email");
      auth.signInWithEmailLink(email, window.location.href)
        .then(() => window.localStorage.removeItem('emailForSignIn'))
        .catch(err => alert("Error: " + err.message));
    }

    auth.onAuthStateChanged(user => {
      if (user) afterLogin(user);
      else {
        loginCard.classList.remove('hide');
        appSection.classList.add('hide');
        userBox.classList.add('hide');
      }
    });

    logoutBtn.addEventListener('click', () => auth.signOut());

    /* Post login with allow-list */
    async function afterLogin(user){
      if(!window.localStorage.getItem(sessKey)) {
        window.localStorage.setItem(sessKey, String(now()));
      }
      setInterval(() => {
        const start = parseInt(window.localStorage.getItem(sessKey) || "0");
        if (now() - start > SESSION_LIMIT_MS) auth.signOut();
      }, 60*1000);

      // === Allow-list check ===
      const doc = await db.collection('allowlist').doc(user.email.toLowerCase()).get();
      if (!doc.exists) {
        alert("This email isn’t authorised for the directory.");
        await auth.signOut();
        return;
      }

      who.textContent = user.email;
      loginCard.classList.add('hide');
      appSection.classList.remove('hide');
      userBox.classList.remove('hide');

      loadContacts();
    }

    /* Load CSV with cache-busting */
    function loadContacts() {
      const CSV_URL = "contacts.csv?v=" + Date.now();
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const rows = results.data.map((row, i) => {
            const name  = row["Name"] || "";
            const batch = String(row["MBBS Batch"] || "").replace(/\.0+$/,"");
            const desig = row["Designation"] || "";
            const place = row["Place of Work"] || row["Place"] || "";
            const phoneRaw = row["Contact no"] || row["Contact"] || "";
            const digits = (phoneRaw+"").replace(/[^0-9]/g,'');
            const tel = digits ? (digits.length===10 ? "+91"+digits
                        : digits.startsWith("91") ? "+"+digits : "+"+digits) : "";
            const wa  = digits ? (digits.length===10 ? "91"+digits
                        : digits.startsWith("91") ? digits : digits) : "";
            return [
              i + 1,
              name,
              batch,
              desig,
              place,
              tel ? `<a href="tel:${tel}">${tel}</a>` : "",
              wa  ? `<a href="https://wa.me/${wa}" target="_blank">Chat</a>` : ""
            ];
          });

          rows.sort((a,b)=>{
            const Ab = parseInt(a[2])||0, Bb = parseInt(b[2])||0;
            if(Ab!==Bb) return Ab-Bb;
            return (a[1]||"").localeCompare(b[1]||"");
          });

          $('#contacts').DataTable({
            data: rows,
            destroy: true,
            columns: [
              { title: "S.No" },
              { title: "Name" },
              { title: "MBBS Batch" },
              { title: "Designation" },
              { title: "Place of Work" },
              { title: "Contact" },
              { title: "WhatsApp" }
            ],
            paging: false,
            searching: true,
            ordering: true,
            responsive: true
          });
        },
        error: function(err) {
          alert("Failed to load contacts: " + (err?.message || err));
        }
      });
    }
  </script>
</body>
</html>