<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sutams Alumni Directory</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body{
      margin:0; padding:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
      background: radial-gradient(1200px 600px at 20% -10%, #e0f2f1, transparent 60%),
                  radial-gradient(1200px 600px at 120% 20%, #bbdefb, transparent 60%),
                  linear-gradient(180deg, #f7fafc, #eef2f7);
    }
    .container{max-width:1100px; margin:0 auto; padding:24px; position:relative;}
    .pageTitle{
      text-align:center; margin:24px 0 8px;
      font-size:34px; font-weight:800; letter-spacing:.2px; color:#0f172a;
      text-shadow:0 1px 0 rgba(255,255,255,.7);
    }
    .userBox{ position:absolute; top:16px; right:16px; display:flex; align-items:center; gap:8px; }
    .pill{ background:#f3f4f6; padding:6px 12px; border-radius:999px; box-shadow:0 1px 0 rgba(0,0,0,.05); }
    .btn{ border:0; border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; color:#fff;
          background:linear-gradient(180deg,#2563eb,#1d4ed8);}
    .btn:hover{ filter:brightness(1.05); }
    .btn.danger{ background:linear-gradient(180deg,#ef4444,#dc2626); }
    .btn[disabled]{ opacity:.75; cursor:not-allowed; }
    .fullBtn{ display:block; width:65%; max-width:280px; margin:8px auto 0; }

    .card{
      background:#fff; border-radius:14px; padding:22px; max-width:520px; margin:16px auto 22px;
      box-shadow:0 20px 35px rgba(15,23,42,.08), 0 2px 6px rgba(15,23,42,.08);
      backdrop-filter: blur(3px);
    }
    .tabs{ display:flex; gap:10px; margin-bottom:12px; }
    .tabs button{ flex:1; padding:10px; border-radius:10px; border:1px solid #e5e7eb; background:#f8fafc; cursor:pointer; font-weight:700; }
    .tabs .active{ color:#fff; border-color:transparent; background:linear-gradient(180deg,#2563eb,#1d4ed8); }
    input{ width:100%; padding:12px 12px; border:1px solid #e5e7eb; border-radius:10px; margin:8px 0; font-size:14px; background:#fff; }
    input.invalid{ border-color:#ef4444; outline: 0; box-shadow:0 0 0 3px rgba(239,68,68,.15); }
    .muted{ font-size:12px; color:#6b7280; }
    .link{ color:#2563eb; text-decoration:none; font-size:12px; }
    .link:hover{ text-decoration:underline; }
    .success{ color:#065f46; background:#d1fae5; border-radius:8px; padding:8px 10px; margin-top:8px; font-size:13px; }
    .error{ color:#b91c1c; background:#fee2e2; border-radius:8px; padding:8px 10px; margin-top:8px; font-size:13px; }
    .hide{ display:none; }

    table{ width:100%; margin-top:14px; background:#fff; border-radius:12px; overflow:hidden; }
    table.dataTable thead th{ background:#f8fafc; }
    #contacts_filter label{ font-weight:700; } /* bold 'Universal Search:' */
  </style>
</head>
<body>
  <div class="container">
    <h1 class="pageTitle">Sutams Alumni Directory</h1>

    <div id="userBox" class="userBox hide">
      <span id="who" class="pill"></span>
      <button id="logoutBtn" class="btn danger" type="button">Log out</button>
    </div>

    <section id="authCard" class="card" autocomplete="off">
      <div class="tabs">
        <button id="tabSignIn" class="active" type="button">Sign in</button>
        <button id="tabSignUp" type="button">Create account</button>
      </div>

      <div id="signInForm">
        <input type="email" id="inEmail" placeholder="Email" autocomplete="username email" />
        <input type="password" id="inPassword" placeholder="Password" autocomplete="new-password" />
        <button id="signInBtn" class="btn fullBtn" type="button">Sign in</button>
        <div class="muted" style="margin-top:6px; text-align:center;">
          Only allow-listed alumni can access. &nbsp;<a href="#" id="forgotPwd" class="link">Forgot password?</a>
        </div>
        <div id="inMsg" class="hide"></div>
      </div>

      <div id="signUpForm" class="hide">
        <input type="text" id="upName" placeholder="Full name" autocomplete="name" />
        <input type="email" id="upEmail" placeholder="Email" autocomplete="username email" />
        <input type="password" id="upPassword" placeholder="Password (min 6 chars)" autocomplete="new-password" />
        <button id="signUpBtn" class="btn fullBtn" type="button">Create account</button>
        <div class="muted" style="margin-top:6px; text-align:center;">
          Your email must already be on the allow-list; otherwise sign-up is blocked.
        </div>
        <div id="upMsg" class="hide"></div>
      </div>
    </section>

    <section id="app" class="hide">
      <table id="contacts" class="display"></table>
    </section>
  </div>

  <!-- Firebase + libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    /* Firebase config */
    const firebaseConfig = {
      apiKey: "AIzaSyAwj6GtC65Q8-xCa3BCLwxGJ8vUArOAHUY",
      authDomain: "sutams-alumni.firebaseapp.com",
      projectId: "sutams-alumni",
      storageBucket: "sutams-alumni.appspot.com",
      messagingSenderId: "817072662829",
      appId: "1:817072662829:web:0ecf3be2338326fb37cba4",
      measurementId: "G-6T86CT10TP"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    /* DOM */
    const authCard   = document.getElementById('authCard');
    const appSection = document.getElementById('app');
    const userBox    = document.getElementById('userBox');
    const who        = document.getElementById('who');
    const logoutBtn  = document.getElementById('logoutBtn');

    const tabSignIn  = document.getElementById('tabSignIn');
    const tabSignUp  = document.getElementById('tabSignUp');
    const signInForm = document.getElementById('signInForm');
    const signUpForm = document.getElementById('signUpForm');

    const inEmail = document.getElementById('inEmail');
    const inPassword = document.getElementById('inPassword');
    const signInBtn = document.getElementById('signInBtn');
    const inMsg = document.getElementById('inMsg');
    const forgotPwd = document.getElementById('forgotPwd');

    const upName = document.getElementById('upName');
    const upEmail = document.getElementById('upEmail');
    const upPassword = document.getElementById('upPassword');
    const signUpBtn = document.getElementById('signUpBtn');
    const upMsg = document.getElementById('upMsg');

    /* Helpers */
    const toLower = s => (s||'').trim().toLowerCase();
    function setMsg(el, text, ok=true){ el.className = ok ? 'success' : 'error'; el.textContent = text; el.classList.remove('hide'); }
    function clearMsgs(){ [inMsg, upMsg].forEach(x=>{x.textContent=''; x.classList.add('hide');}); }
    function clearPw(){ inPassword.value=''; upPassword.value=''; }
    function touchInvalid(input, bad){ input.classList.toggle('invalid', !!bad); }
    function missingFieldsReport(name, email, pwd){
      const miss = []; if(!name) miss.push('Name'); if(!email) miss.push('Email'); if(!pwd) miss.push('Password');
      return miss.length ? ('Missing: ' + miss.join(', ') + '.') : '';
    }
    function setBusy(btn, busy, normal, busyTxt){
      if(!btn) return; btn.disabled = !!busy; btn.textContent = busy ? (busyTxt||'Please wait…') : (normal||btn.textContent);
    }

    /* Tabs */
    tabSignIn.onclick = (e) => { e.preventDefault(); clearMsgs();
      tabSignIn.classList.add('active'); tabSignUp.classList.remove('active');
      signInForm.classList.remove('hide'); signUpForm.classList.add('hide');
    };
    tabSignUp.onclick = (e) => { e.preventDefault(); clearMsgs();
      tabSignUp.classList.add('active'); tabSignIn.classList.remove('active');
      signUpForm.classList.remove('hide'); signInForm.classList.add('hide');
    };

    /* Allow-list check */
    async function isAllowed(emailLower){
      try{
        const snap = await db.collection('allowlist').doc(emailLower).get();
        return snap.exists && (snap.data().allowed === true);
      }catch{ return false; }
    }

    /* Guard to suppress UI during Firebase's auto sign-in after create */
    let suppressAuthUI = false;

    /* Sign up */
    signUpBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      clearMsgs();

      const name = (upName.value || '').trim();
      const email= (upEmail.value||'').trim().toLowerCase();
      const pwd  = (upPassword.value||'');

      touchInvalid(upName, !name);
      touchInvalid(upEmail, !email);
      touchInvalid(upPassword, !pwd);

      if (!name || !email || !pwd){
        setMsg(upMsg, missingFieldsReport(name,email,pwd), false);
        return;
      }
      if (pwd.length < 6){
        touchInvalid(upPassword, true);
        setMsg(upMsg, 'Password is too short (min 6 characters).', false);
        return;
      }

      setBusy(signUpBtn, true, 'Create account', 'Creating…');
      try{
        if(!(await isAllowed(email))){
          setMsg(upMsg,'Not authorised to sign up. Contact administrator.', false);
          return;
        }

        suppressAuthUI = true;                       // prevent flicker UI
        const cred = await auth.createUserWithEmailAndPassword(email, pwd);
        await cred.user.updateProfile({displayName:name});
        await auth.signOut();                        // immediately sign out
        suppressAuthUI = false;                      // re-enable listener UI

        inEmail.value = email;                       // prefill sign-in
        upPassword.value = '';                       // clear password field
        tabSignIn.click();
        setMsg(inMsg,'Sign-up successful. Please sign in.', true);
      }catch(e){
        suppressAuthUI = false;
        if(e.code === 'auth/email-already-in-use'){
          inEmail.value = email; tabSignIn.click();
          setMsg(inMsg,'Account already exists. Please sign in or use “Forgot password”.', true);
        }else if(e.code === 'auth/weak-password'){
          setMsg(upMsg,'Password is too weak. Use at least 6 characters.', false);
        }else if(e.code === 'auth/network-request-failed'){
          setMsg(upMsg,'Network error. Please try again.', false);
        }else{
          setMsg(upMsg,'Sign up failed. Please try again.', false);
        }
      } finally {
        setBusy(signUpBtn, false, 'Create account');
      }
    });

    /* Sign in — friendly errors only */
    signInBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      clearMsgs();
      const email = (inEmail.value||'').trim().toLowerCase();
      const pwd   = (inPassword.value||'');
      touchInvalid(inEmail, !email);
      touchInvalid(inPassword, !pwd);
      if(!email || !pwd){
        setMsg(inMsg, missingFieldsReport(email? 'x':'' , email, pwd), false);
        return;
      }

      setBusy(signInBtn, true, 'Sign in', 'Signing in…');
      try{
        await auth.signInWithEmailAndPassword(email, pwd);
      }catch(e){
        const friendly = new Set([
          'auth/invalid-login-credentials',
          'auth/invalid-credential',
          'auth/user-not-found',
          'auth/wrong-password'
        ]);
        setMsg(inMsg, friendly.has(e.code) ? 'Invalid email or password.' : 'Sign in failed. Please try again.', false);
        clearPw();
      } finally {
        setBusy(signInBtn, false, 'Sign in');
      }
    });

    /* Reset password */
    document.getElementById('forgotPwd').addEventListener('click', async (e)=>{
      e.preventDefault();
      const email = (inEmail.value||prompt('Enter your email for a reset link:')||'').trim().toLowerCase();
      if(!email) return;
      try{ await auth.sendPasswordResetEmail(email); setMsg(inMsg, 'Password reset email sent to ' + email, true); }
      catch{ setMsg(inMsg, 'Could not send reset email. Try again later.', false); }
    });

    /* Session cap: 14 days */
    const SESSION_LIMIT_MS = 14*24*60*60*1000, sessKey='sessStart';
    const now = ()=>Date.now();

    /* Auth state */
    auth.onAuthStateChanged(async (user)=>{
      if(suppressAuthUI) return;    // <— key line: ignore auto-login during signup

      if(user){
        const emailLower = (user.email||'').toLowerCase();
        if(!(await isAllowed(emailLower))){
          alert('This email is not authorised for the directory.');
          await auth.signOut(); return;
        }
        if(!localStorage.getItem(sessKey)) localStorage.setItem(sessKey, String(now()));
        setInterval(()=>{ const start = +localStorage.getItem(sessKey)||0;
          if(now()-start > SESSION_LIMIT_MS) auth.signOut(); }, 60*1000);

        who.textContent = user.displayName ? `${user.displayName} (${emailLower})` : emailLower;
        authCard.classList.add('hide'); appSection.classList.remove('hide'); userBox.classList.remove('hide');
        clearPw(); clearMsgs(); loadContacts();
      }else{
        authCard.classList.remove('hide'); appSection.classList.add('hide'); userBox.classList.add('hide');
        clearPw();
      }
    });
    logoutBtn.addEventListener('click', ()=> auth.signOut());

    /* Contacts CSV */
    function loadContacts(){
      Papa.parse('contacts.csv?v='+Date.now(), {
        download:true, header:true, skipEmptyLines:true,
        complete: (res)=>{
          const rows = res.data.map((r,i)=>{
            const name  = r['Name']||'';
            const batch = String(r['MBBS Batch']||'').replace(/\.0+$/,'');
            const desig = r['Designation']||'';
            const place = r['Place of Work']||r['Place']||'';
            const phone = (r['Contact no']||r['Contact']||'')+'';
            const digits = phone.replace(/[^0-9]/g,'');
            const tel = digits ? (digits.length===10 ? '+91'+digits : digits.startsWith('91')? '+'+digits : '+'+digits) : '';
            const wa  = digits ? (digits.length===10 ? '91'+digits : digits.startsWith('91')? digits : digits) : '';
            return [
              i+1, name, batch, desig, place,
              tel ? `<a href="tel:${tel}">${tel}</a>` : '',
              wa  ? `<a href="https://wa.me/${wa}" target="_blank">Chat</a>` : ''
            ];
          });
          rows.sort((a,b)=>{
            const Ab = parseInt(a[2])||0, Bb = parseInt(b[2])||0;
            if(Ab !== Bb) return Ab - Bb;
            return (a[1]||'').localeCompare(b[1]||'');
          });
          $('#contacts').DataTable({
            data: rows,
            destroy:true,
            columns: [
              { title:'S.No' },
              { title:'Name' },
              { title:'MBBS Batch' },
              { title:'Designation' },
              { title:'Place of Work' },
              { title:'Contact' },
              { title:'WhatsApp' }
            ],
            paging:false,
            searching:true,
            ordering:true,
            responsive:true,
            language:{
              search: 'Universal Search:',
              searchPlaceholder: 'Search name, batch, designation, place, phone…'
            }
          });
        },
        error:()=> alert('Failed to load contacts.')
      });
    }
  });
  </script>
</body>
</html>