<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sutams Alumni Directory</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <style>
    /* Page look */
    body{
      margin:0; padding:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
      background: radial-gradient(1200px 600px at 20% -10%, #e0f2f1, transparent 60%),
                  radial-gradient(1200px 600px at 120% 20%, #bbdefb, transparent 60%),
                  linear-gradient(180deg, #f7fafc, #eef2f7);
    }
    .container{max-width:1100px; margin:0 auto; padding:24px; position:relative;}

    /* Centered title */
    .pageTitle{
      text-align:center; margin:24px 0 8px;
      font-size:34px; font-weight:800; letter-spacing:.2px; color:#0f172a;
      text-shadow:0 1px 0 rgba(255,255,255,.7);
    }

    /* User chip floats top-right */
    .userBox{
      position:absolute; top:16px; right:16px;
      display:flex; align-items:center; gap:8px;
    }
    .pill{background:#f3f4f6; padding:6px 12px; border-radius:999px; box-shadow:0 1px 0 rgba(0,0,0,.05);}
    .btn{border:0; border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; color:#fff;
         background:linear-gradient(180deg,#2563eb,#1d4ed8);}
    .btn:hover{filter:brightness(1.05);}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);}

    /* Auth card */
    .card{
      background:#fff; border-radius:14px; padding:22px; max-width:480px; margin:16px auto 22px;
      box-shadow:0 20px 35px rgba(15,23,42,.08), 0 2px 6px rgba(15,23,42,.08);
      backdrop-filter: blur(3px);
    }
    .tabs{display:flex; gap:10px; margin-bottom:12px;}
    .tabs button{flex:1; padding:10px; border-radius:10px; border:1px solid #e5e7eb; background:#f8fafc; cursor:pointer; font-weight:700;}
    .tabs .active{color:#fff; border-color:transparent; background:linear-gradient(180deg,#2563eb,#1d4ed8);}
    input{width:100%; padding:12px 12px; border:1px solid #e5e7eb; border-radius:10px; margin:8px 0; font-size:14px; background:#fff;}
    input[type="email"]{autocomplete:username;}
    input[type="password"]{autocomplete:new-password;}
    .muted{font-size:12px; color:#6b7280;}
    .link{color:#2563eb; text-decoration:none; font-size:12px;}
    .link:hover{text-decoration:underline;}
    .success{color:#065f46; background:#d1fae5; border-radius:8px; padding:8px 10px; margin-top:8px; font-size:13px;}
    .error{color:#b91c1c; background:#fee2e2; border-radius:8px; padding:8px 10px; margin-top:8px; font-size:13px;}
    .hide{display:none;}

    /* Table */
    table{width:100%; margin-top:14px; background:#fff; border-radius:12px; overflow:hidden;}
    table.dataTable thead th{background:#f8fafc;}
  </style>
</head>
<body>
  <div class="container">
    <!-- Centered heading -->
    <h1 class="pageTitle">Sutams Alumni Directory</h1>

    <!-- User chip -->
    <div id="userBox" class="userBox hide">
      <span id="who" class="pill"></span>
      <button id="logoutBtn" class="btn danger">Log out</button>
    </div>

    <!-- Auth -->
    <section id="authCard" class="card" autocomplete="off">
      <div class="tabs">
        <button id="tabSignIn" class="active">Sign in</button>
        <button id="tabSignUp">Create account</button>
      </div>

      <div id="signInForm">
        <input type="email" id="inEmail" placeholder="Email" autocomplete="email">
        <input type="password" id="inPassword" placeholder="Password" autocomplete="new-password" name="pw_signin_x7f">
        <button id="signInBtn" class="btn" style="width:100%;">Sign in</button>
        <div class="muted" style="margin-top:6px;">Only allow-listed alumni can access. <a href="#" id="forgotPwd" class="link">Forgot password?</a></div>
        <div id="inMsg" class="hide"></div>
      </div>

      <div id="signUpForm" class="hide">
        <input type="text" id="upName" placeholder="Full name" autocomplete="name">
        <input type="email" id="upEmail" placeholder="Email" autocomplete="email">
        <input type="password" id="upPassword" placeholder="Password (min 6 chars)" autocomplete="new-password" name="pw_signup_k3q">
        <button id="signUpBtn" class="btn" style="width:100%;">Create account</button>
        <div class="muted" style="margin-top:6px;">Your email must already be on the allow-list; otherwise sign-up is blocked.</div>
        <div id="upMsg" class="hide"></div>
      </div>
    </section>

    <!-- Directory -->
    <section id="app" class="hide">
      <table id="contacts" class="display"></table>
    </section>
  </div>

  <!-- Firebase + libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /* Firebase config */
    const firebaseConfig = {
      apiKey: "AIzaSyAwj6GtC65Q8-xCa3BCLwxGJ8vUArOAHUY",
      authDomain: "sutams-alumni.firebaseapp.com",
      projectId: "sutams-alumni",
      storageBucket: "sutams-alumni.appspot.com",
      messagingSenderId: "817072662829",
      appId: "1:817072662829:web:0ecf3be2338326fb37cba4",
      measurementId: "G-6T86CT10TP"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    /* DOM */
    const authCard   = document.getElementById('authCard');
    const appSection = document.getElementById('app');
    const userBox    = document.getElementById('userBox');
    const who        = document.getElementById('who');
    const logoutBtn  = document.getElementById('logoutBtn');

    const tabSignIn  = document.getElementById('tabSignIn');
    const tabSignUp  = document.getElementById('tabSignUp');
    const signInForm = document.getElementById('signInForm');
    const signUpForm = document.getElementById('signUpForm');

    const inEmail = document.getElementById('inEmail');
    const inPassword = document.getElementById('inPassword');
    const signInBtn = document.getElementById('signInBtn');
    const inMsg = document.getElementById('inMsg');
    const forgotPwd = document.getElementById('forgotPwd');

    const upName = document.getElementById('upName');
    const upEmail = document.getElementById('upEmail');
    const upPassword = document.getElementById('upPassword');
    const signUpBtn = document.getElementById('signUpBtn');
    const upMsg = document.getElementById('upMsg');

    /* Helpers */
    const toLower = s => (s||'').trim().toLowerCase();
    function setMsg(el, text, ok=true){ el.className = ok ? 'success' : 'error'; el.textContent = text; el.classList.remove('hide'); }
    function clearMsgs(){ [inMsg, upMsg].forEach(x=>{x.textContent=''; x.classList.add('hide');}); }
    function clearPw(){ inPassword.value=''; upPassword.value=''; }

    tabSignIn.onclick = () => { clearMsgs(); clearPw();
      tabSignIn.classList.add('active'); tabSignUp.classList.remove('active');
      signInForm.classList.remove('hide'); signUpForm.classList.add('hide');
    };
    tabSignUp.onclick = () => { clearMsgs(); clearPw();
      tabSignUp.classList.add('active'); tabSignIn.classList.remove('active');
      signUpForm.classList.remove('hide'); signInForm.classList.add('hide');
    };

    /* Allow-list check */
    async function isAllowed(emailLower){
      try{
        const snap = await db.collection('allowlist').doc(emailLower).get();
        return snap.exists && (snap.data().allowed === true);
      }catch{ return false; }
    }

    /* Sign up (no auto-login) */
    signUpBtn.addEventListener('click', async ()=>{
      clearMsgs(); clearPw();
      const name = upName.value.trim();
      const email = toLower(upEmail.value);
      const pwd = upPassword.value;
      if(!name || !email || !pwd){ setMsg(upMsg,'Please fill name, email and password.', false); return; }
      if(!(await isAllowed(email))){ setMsg(upMsg,'Not authorised. Contact administrator.', false); return; }

      try{
        const cred = await auth.createUserWithEmailAndPassword(email, pwd);
        await cred.user.updateProfile({displayName:name});
        await auth.signOut();
        inEmail.value = email; clearPw();
        tabSignIn.click();
        setMsg(inMsg,'Sign-up successful. Please sign in.', true);
      }catch(e){
        if(e.code === 'auth/email-already-in-use'){
          inEmail.value = email; tabSignIn.click();
          setMsg(inMsg,'Account already exists. Please sign in or use “Forgot password”.', true);
        }else{
          setMsg(upMsg, e.message, false);
        }
      }
    });

    /* Sign in */
    signInBtn.addEventListener('click', async ()=>{
      clearMsgs();
      const email = toLower(inEmail.value), pwd = inPassword.value;
      if(!email || !pwd){ setMsg(inMsg,'Enter email and password.', false); return; }
      try{ await auth.signInWithEmailAndPassword(email, pwd); }
      catch(e){ setMsg(inMsg, e.message, false); clearPw(); }
    });

    /* Reset password */
    forgotPwd.addEventListener('click', async (e)=>{
      e.preventDefault();
      const email = toLower(inEmail.value || prompt('Enter your email for a reset link:') || '');
      if(!email) return;
      try{ await auth.sendPasswordResetEmail(email); setMsg(inMsg, 'Password reset email sent to ' + email, true); }
      catch(e){ setMsg(inMsg, e.message, false); }
    });

    /* Session: 14 days cap */
    const SESSION_LIMIT_MS = 14*24*60*60*1000, sessKey='sessStart';
    const now = ()=>Date.now();

    /* Auth state */
    auth.onAuthStateChanged(async (user)=>{
      if(user){
        const emailLower = toLower(user.email);
        if(!(await isAllowed(emailLower))){
          alert('This email is not authorised for the directory.');
          await auth.signOut(); return;
        }
        if(!localStorage.getItem(sessKey)) localStorage.setItem(sessKey, String(now()));
        setInterval(()=>{ const start = +localStorage.getItem(sessKey)||0;
          if(now()-start > SESSION_LIMIT_MS) auth.signOut(); }, 60*1000);

        who.textContent = user.displayName ? `${user.displayName} (${emailLower})` : emailLower;
        authCard.classList.add('hide'); appSection.classList.remove('hide'); userBox.classList.remove('hide');
        clearPw(); clearMsgs(); loadContacts();
      }else{
        authCard.classList.remove('hide'); appSection.classList.add('hide'); userBox.classList.add('hide');
        clearPw();
      }
    });
    logoutBtn.addEventListener('click', ()=> auth.signOut());

    /* Load CSV */
    function loadContacts(){
      Papa.parse('contacts.csv?v='+Date.now(), {
        download:true, header:true, skipEmptyLines:true,
        complete: (res)=>{
          const rows = res.data.map((r,i)=>{
            const name  = r['Name']||'';
            const batch = String(r['MBBS Batch']||'').replace(/\.0+$/,'');
            const desig = r['Designation']||'';
            const place = r['Place of Work']||r['Place']||'';
            const phone = (r['Contact no']||r['Contact']||'')+'';
            const digits = phone.replace(/[^0-9]/g,'');
            const tel = digits ? (digits.length===10 ? '+91'+digits : digits.startsWith('91')? '+'+digits : '+'+digits) : '';
            const wa  = digits ? (digits.length===10 ? '91'+digits : digits.startsWith('91')? digits : digits) : '';
            return [
              i+1, name, batch, desig, place,
              tel ? `<a href="tel:${tel}">${tel}</a>` : '',
              wa  ? `<a href="https://wa.me/${wa}" target="_blank">Chat</a>` : ''
            ];
          });

          // Sort by batch, then name (A–Z)
          rows.sort((a,b)=>{
            const Ab = parseInt(a[2])||0, Bb = parseInt(b[2])||0;
            if(Ab !== Bb) return Ab - Bb;
            return (a[1]||'').localeCompare(b[1]||'');
          });

          $('#contacts').DataTable({
            data: rows,
            destroy:true,
            columns: [
              { title:'S.No' },
              { title:'Name' },
              { title:'MBBS Batch' },
              { title:'Designation' },
              { title:'Place of Work' },
              { title:'Contact' },
              { title:'WhatsApp' }
            ],
            paging:false,         /* show full list */
            searching:true,
            ordering:true,
            responsive:true,
            language:{
              search: 'Universal Search:',
              searchPlaceholder: 'Search name, MBBS batch, designation, place of work, phone…'
            }
          });
        },
        error:(err)=> alert('Failed to load contacts: '+(err?.message||err))
      });
    }
  </script>
</body>
</html>