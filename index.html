<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sutams Alumni Directory</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6f8;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }
    .pageTitle {
      text-align: center;
      margin: 20px 0 10px;
      font-size: 32px;
      font-weight: 700;
      color: #111827;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin: 30px auto;
      max-width: 420px;
    }
    .card h2 { margin-top: 0; }
    input[type="email"], input[type="password"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    input[type="email"] { autocomplete: username; }
    input[type="password"] { autocomplete: new-password; }
    .btn {
      background: #2563eb;
      color: #fff;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:hover { background: #1d4ed8; }
    .btn.danger { background: #dc2626; }
    .btn.danger:hover { background: #b91c1c; }
    .pill {
      background: #e9ecef;
      padding: 5px 10px;
      border-radius: 20px;
      margin-right: 10px;
    }
    .userBox {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .hide { display: none; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
    .tabs { display: flex; margin-bottom: 15px; }
    .tabs button {
      flex: 1; padding: 10px; cursor: pointer;
      border: 1px solid #ccc; background: #f9fafb;
    }
    .tabs button.active { background: #2563eb; color: white; }
    .message { text-align: center; color: green; margin-top: 10px; }
    .error { text-align: center; color: red; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">

    <!-- Centered Heading -->
    <h1 class="pageTitle">Sutams Alumni Directory</h1>

    <!-- User chip & logout -->
    <div id="userBox" class="userBox hide">
      <span id="who" class="pill"></span>
      <button id="logoutBtn" class="btn danger">Log out</button>
    </div>

    <!-- Login box -->
    <section id="loginCard" class="card login">
      <div class="tabs">
        <button id="tabSignIn" class="active">Sign in</button>
        <button id="tabSignUp">Create account</button>
      </div>
      <div id="signinForm">
        <input type="email" id="email" placeholder="Email" autocomplete="username">
        <input type="password" id="password" placeholder="Password" autocomplete="new-password">
        <button id="loginBtn" class="btn">Sign in</button>
        <p style="font-size:12px;color:#555;">Only allow-listed alumni can access.</p>
        <a href="#" id="resetLink" style="font-size:12px;">Forgot password?</a>
      </div>
      <div id="signupForm" class="hide">
        <input type="email" id="signupEmail" placeholder="Email" autocomplete="username">
        <input type="password" id="signupPass" placeholder="Password" autocomplete="new-password">
        <button id="signupBtn" class="btn">Create account</button>
        <p style="font-size:12px;color:#555;">Only allow-listed alumni can register.</p>
      </div>
      <p id="msgBox" class="message hide"></p>
      <p id="errBox" class="error hide"></p>
    </section>

    <!-- Protected directory -->
    <section id="app" class="hide">
      <label for="contacts_filter">Universal Search:</label>
      <table id="contacts" class="display"></table>
    </section>
  </div>

  <!-- Firebase + DataTables + PapaParse -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAwj6GtC65Q8-xCa3BCLwxGJ8vUArOAHUY",
      authDomain: "sutams-alumni.firebaseapp.com",
      projectId: "sutams-alumni",
      storageBucket: "sutams-alumni.firebasestorage.app",
      messagingSenderId: "817072662829",
      appId: "1:817072662829:web:0ecf3be2338326fb37cba4",
      measurementId: "G-6T86CT10TP"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginCard = document.getElementById('loginCard');
    const appSection = document.getElementById('app');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('password');
    const signupEmail = document.getElementById('signupEmail');
    const signupPass = document.getElementById('signupPass');
    const who = document.getElementById('who');
    const userBox = document.getElementById('userBox');
    const logoutBtn = document.getElementById('logoutBtn');
    const msgBox = document.getElementById('msgBox');
    const errBox = document.getElementById('errBox');
    const tabSignIn = document.getElementById('tabSignIn');
    const tabSignUp = document.getElementById('tabSignUp');
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    const resetLink = document.getElementById('resetLink');

    function showMsg(msg) {
      msgBox.textContent = msg;
      msgBox.classList.remove('hide');
      errBox.classList.add('hide');
    }
    function showErr(msg) {
      errBox.textContent = msg;
      errBox.classList.remove('hide');
      msgBox.classList.add('hide');
    }

    tabSignIn.onclick = () => {
      tabSignIn.classList.add("active");
      tabSignUp.classList.remove("active");
      signinForm.classList.remove("hide");
      signupForm.classList.add("hide");
      msgBox.classList.add("hide");
      errBox.classList.add("hide");
    };

    tabSignUp.onclick = () => {
      tabSignUp.classList.add("active");
      tabSignIn.classList.remove("active");
      signupForm.classList.remove("hide");
      signinForm.classList.add("hide");
      msgBox.classList.add("hide");
      errBox.classList.add("hide");
    };

    signupBtn.addEventListener('click', async () => {
      try {
        const userCred = await auth.createUserWithEmailAndPassword(signupEmail.value, signupPass.value);
        const doc = await db.collection('allowlist').doc(signupEmail.value.toLowerCase()).get();
        if (!doc.exists || !doc.data().allowed) {
          showErr("Not authorised. Contact administrator.");
          await auth.currentUser.delete();
          return;
        }
        showMsg("Sign up successful. Please sign in.");
      } catch (err) {
        showErr(err.message);
      }
    });

    loginBtn.addEventListener('click', async () => {
      try {
        await auth.signInWithEmailAndPassword(emailInput.value, passInput.value);
      } catch (err) {
        showErr(err.message);
      }
    });

    resetLink.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = prompt("Enter your email to reset password:");
      if (!email) return;
      try {
        await auth.sendPasswordResetEmail(email);
        showMsg("Password reset link sent to " + email);
      } catch (err) {
        showErr(err.message);
      }
    });

    auth.onAuthStateChanged(async user => {
      if (user) {
        const doc = await db.collection('allowlist').doc(user.email.toLowerCase()).get();
        if (!doc.exists || !doc.data().allowed) {
          alert("This email isnâ€™t authorised for the directory.");
          await auth.signOut();
          return;
        }
        who.textContent = user.email;
        loginCard.classList.add('hide');
        appSection.classList.remove('hide');
        userBox.classList.remove('hide');
        loadContacts();
      } else {
        loginCard.classList.remove('hide');
        appSection.classList.add('hide');
        userBox.classList.add('hide');
      }
    });

    logoutBtn.addEventListener('click', () => auth.signOut());

    function loadContacts() {
      const CSV_URL = "contacts.csv?v=" + Date.now();
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const rows = results.data.map((row, i) => {
            const name  = row["Name"] || "";
            const batch = String(row["MBBS Batch"] || "").replace(/\.0+$/,"");
            const desig = row["Designation"] || "";
            const place = row["Place of Work"] || "";
            const phoneRaw = row["Contact no"] || row["Contact"] || "";
            const digits = (phoneRaw+"").replace(/[^0-9]/g,'');
            const tel = digits ? (digits.length===10 ? "+91"+digits : digits.startsWith("91") ? "+"+digits : "+"+digits) : "";
            const wa  = digits ? (digits.length===10 ? "91"+digits : digits.startsWith("91") ? digits : digits) : "";
            return [
              i + 1,
              name,
              batch,
              desig,
              place,
              tel ? `<a href="tel:${tel}">${tel}</a>` : "",
              wa  ? `<a href="https://wa.me/${wa}" target="_blank">Chat</a>` : ""
            ];
          });
          new DataTable("#contacts", {
            data: rows,
            columns: [
              { title: "S.No" },
              { title: "Name" },
              { title: "MBBS Batch" },
              { title: "Designation" },
              { title: "Place of Work" },
              { title: "Contact" },
              { title: "WhatsApp" }
            ],
            pageLength: 1000,
            responsive: true
          });
        }
      });
    }
  </script>
</body>
</html>