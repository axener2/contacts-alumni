<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sutams Alumni Directory</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <style>
    body{
      font-family: Arial, sans-serif; margin:0; padding:0;
      background: linear-gradient(135deg,#e0f2f1,#bbdefb);
      min-height:100vh; display:flex; align-items:flex-start; justify-content:center;
    }
    .container{width:100%; max-width:1000px; padding:20px;}
    .headerBar{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; margin:10px 0 12px;
    }
    .pageTitle{ margin:0; font-size:28px; font-weight:700; color:#111827; }
    .userBox{ display:flex; align-items:center; gap:8px; }
    .pill{background:#f3f4f6; padding:6px 12px; border-radius:20px;}
    .btn{background:#2563eb; color:#fff; padding:10px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:600;}
    .btn:hover{background:#1d4ed8;}
    .btn.danger{background:#dc2626;} .btn.danger:hover{background:#b91c1c;}

    .card{
      background:#fff; border-radius:10px; padding:24px; margin:10px auto; max-width:480px;
      box-shadow:0 6px 12px rgba(0,0,0,.15);
    }
    .tabs{display:flex; gap:8px; margin-bottom:16px;}
    .tabs button{flex:1; padding:10px; border:none; border-radius:6px; cursor:pointer; background:#e5e7eb; font-weight:600;}
    .tabs .active{background:#2563eb; color:#fff;}
    input{width:100%; padding:12px; margin:10px 0; border-radius:6px; border:1px solid #ccc; font-size:14px;}
    .muted{font-size:13px; color:#6b7280; margin-top:6px;}
    .error{color:#b91c1c; font-size:13px; margin-top:6px;}
    .success{color:#065f46; background:#d1fae5; padding:8px 10px; border-radius:6px; font-size:13px; margin-top:8px;}
    a.link{color:#2563eb; text-decoration:none; font-size:13px;} a.link:hover{text-decoration:underline;}
    .hide{display:none;}
    table{width:100%; margin-top:16px;}
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <div class="headerBar">
      <h1 class="pageTitle">Sutams Alumni Directory</h1>
      <div id="userBox" class="userBox hide">
        <span id="who" class="pill"></span>
        <button id="logoutBtn" class="btn danger">Log out</button>
      </div>
    </div>

    <!-- Auth card (autocomplete off to avoid saved passwords) -->
    <section id="authCard" class="card" autocomplete="off">
      <div class="tabs">
        <button id="tabSignIn" class="active">Sign in</button>
        <button id="tabSignUp">Create account</button>
      </div>

      <!-- Sign in -->
      <div id="signInForm">
        <input type="email" id="inEmail" placeholder="Email" autocomplete="email" />
        <!-- random name + new-password block autofill -->
        <input type="password" id="inPassword" placeholder="Password"
               autocomplete="new-password" name="pw_signin_x7f" />
        <button id="signInBtn" class="btn">Sign in</button>
        <p class="muted">Only allow-listed alumni can access.</p>
        <a href="#" id="forgotPwd" class="link">Forgot password?</a>
        <p id="inMsg" class="error"></p>
      </div>

      <!-- Sign up -->
      <div id="signUpForm" class="hide">
        <input type="text" id="upName" placeholder="Full name" autocomplete="name" />
        <input type="email" id="upEmail" placeholder="Email" autocomplete="email" />
        <input type="password" id="upPassword" placeholder="Password (min 6 chars)"
               autocomplete="new-password" name="pw_signup_k3q" />
        <button id="signUpBtn" class="btn">Create account</button>
        <p class="muted">Your email must already be on the allow-list; otherwise sign-up is blocked.</p>
        <p id="upMsg" class="error"></p>
      </div>
    </section>

    <!-- Protected directory -->
    <section id="app" class="hide">
      <table id="contacts" class="display"></table>
    </section>
  </div>

  <!-- Firebase + libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /* ===== Firebase config (your project) ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyAwj6GtC65Q8-xCa3BCLwxGJ8vUArOAHUY",
      authDomain: "sutams-alumni.firebaseapp.com",
      projectId: "sutams-alumni",
      storageBucket: "sutams-alumni.appspot.com",
      messagingSenderId: "817072662829",
      appId: "1:817072662829:web:0ecf3be2338326fb37cba4",
      measurementId: "G-6T86CT10TP"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    /* ===== DOM ===== */
    const authCard   = document.getElementById('authCard');
    const appSection = document.getElementById('app');
    const userBox    = document.getElementById('userBox');
    const who        = document.getElementById('who');
    const logoutBtn  = document.getElementById('logoutBtn');

    const tabSignIn  = document.getElementById('tabSignIn');
    const tabSignUp  = document.getElementById('tabSignUp');
    const signInForm = document.getElementById('signInForm');
    const signUpForm = document.getElementById('signUpForm');

    const inEmail = document.getElementById('inEmail');
    const inPassword = document.getElementById('inPassword');
    const signInBtn = document.getElementById('signInBtn');
    const inMsg = document.getElementById('inMsg');
    const forgotPwd = document.getElementById('forgotPwd');

    const upName = document.getElementById('upName');
    const upEmail = document.getElementById('upEmail');
    const upPassword = document.getElementById('upPassword');
    const signUpBtn = document.getElementById('signUpBtn');
    const upMsg = document.getElementById('upMsg');

    /* ===== helpers to keep passwords empty ===== */
    function clearPasswords() {
      inPassword.value = '';
      upPassword.value = '';
      // also mark inputs as not-autofilled (helps some browsers)
      inPassword.setAttribute('autocomplete','new-password');
      upPassword.setAttribute('autocomplete','new-password');
    }
    // Clear immediately on load
    clearPasswords();

    function showSignInTab(messageHTML='') {
      tabSignIn.classList.add('active'); tabSignUp.classList.remove('active');
      signInForm.classList.remove('hide'); signUpForm.classList.add('hide');
      inMsg.className = messageHTML ? 'success' : 'error';
      inMsg.innerHTML = messageHTML;
      clearPasswords();
      if (messageHTML) setTimeout(()=>{ inMsg.textContent=''; inMsg.className='error'; }, 5000);
    }

    tabSignIn.onclick = () => showSignInTab();
    tabSignUp.onclick = () => {
      tabSignUp.classList.add('active'); tabSignIn.classList.remove('active');
      signUpForm.classList.remove('hide'); signInForm.classList.add('hide');
      upMsg.textContent = '';
      clearPasswords();
    };

    /* ===== Session (14 days only) ===== */
    const SESSION_LIMIT_MS = 14*24*60*60*1000;
    const sessKey = 'sessStart';
    const now = () => Date.now();
    const toLower = s => (s||"").trim().toLowerCase();

    /* ===== Allow-list check (allowed === true) ===== */
    async function isAllowedEmail(emailLower) {
      try {
        const snap = await db.collection('allowlist').doc(emailLower).get();
        if (!snap.exists) return false;
        const data = snap.data() || {};
        return data.allowed === true;
      } catch { return false; }
    }

    /* ===== Sign up (no auto-login) ===== */
    signUpBtn.addEventListener('click', async () => {
      upMsg.textContent = '';
      const name  = upName.value.trim();
      const email = toLower(upEmail.value);
      const pwd   = upPassword.value;

      if (!name || !email || !pwd) { upMsg.textContent='Please fill name, email and password.'; return; }
      if (!(await isAllowedEmail(email))) { upMsg.textContent = 'Not authorised. Contact administrator.'; clearPasswords(); return; }

      try {
        const cred = await auth.createUserWithEmailAndPassword(email, pwd);
        await cred.user.updateProfile({ displayName: name });
        await auth.signOut();
        inEmail.value = email;        // keep only email for convenience
        showSignInTab('Sign-up successful. Please sign in.');
      } catch (e) {
        if (e.code === 'auth/email-already-in-use') {
          inEmail.value = email;
          showSignInTab('Account already exists. Please sign in or use “Forgot password”.');
        } else {
          upMsg.textContent = e.message;
        }
        clearPasswords();
      }
    });

    /* ===== Sign in ===== */
    signInBtn.addEventListener('click', async () => {
      inMsg.textContent = '';
      const email = toLower(inEmail.value);
      const pwd   = inPassword.value;
      if (!email || !pwd) { inMsg.textContent = 'Enter email and password.'; return; }
      try {
        await auth.signInWithEmailAndPassword(email, pwd);
      } catch (e) {
        inMsg.textContent = e.message;
        clearPasswords();
      }
    });

    /* ===== Reset password ===== */
    forgotPwd.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = toLower(inEmail.value);
      if (!email) { alert('Enter your email above first.'); return; }
      try {
        await auth.sendPasswordResetEmail(email);
        alert('Password reset email sent to ' + email);
      } catch (e) { alert('Error: ' + e.message); }
    });

    /* ===== Auth state & post-login ===== */
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const emailLower = toLower(user.email);
        if (!(await isAllowedEmail(emailLower))) {
          alert('This email is not authorised for the directory.');
          await auth.signOut(); return;
        }
        if (!localStorage.getItem(sessKey)) localStorage.setItem(sessKey, String(now()));
        setInterval(() => {
          const start = parseInt(localStorage.getItem(sessKey) || '0', 10);
          if (now() - start > SESSION_LIMIT_MS) auth.signOut();
        }, 60*1000);

        who.textContent = user.displayName ? `${user.displayName} (${emailLower})` : emailLower;
        authCard.classList.add('hide');
        appSection.classList.remove('hide');
        userBox.classList.remove('hide');
        clearPasswords();
        loadContacts();
      } else {
        authCard.classList.remove('hide');
        appSection.classList.add('hide');
        userBox.classList.add('hide');
        clearPasswords();
      }
    });

    logoutBtn.addEventListener('click', () => {
      auth.signOut();
      clearPasswords();
    });

    /* ===== Load contacts.csv (cache-busting) ===== */
    function loadContacts() {
      const CSV_URL = 'contacts.csv?v=' + Date.now();
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const rows = results.data.map((row, i) => {
            const name  = row['Name'] || '';
            const batch = String(row['MBBS Batch'] || '').replace(/\.0+$/, '');
            const desig = row['Designation'] || '';
            const place = row['Place of Work'] || row['Place'] || '';
            const phoneRaw = row['Contact no'] || row['Contact'] || '';
            const digits = (phoneRaw + '').replace(/[^0-9]/g, '');
            const tel = digits ? (digits.length === 10 ? '+91' + digits
                        : digits.startsWith('91') ? '+' + digits : '+' + digits) : '';
            const wa  = digits ? (digits.length === 10 ? '91' + digits
                        : digits.startsWith('91') ? digits : digits) : '';
            return [
              i + 1,
              name,
              batch,
              desig,
              place,
              tel ? `<a href="tel:${tel}">${tel}</a>` : '',
              wa  ? `<a href="https://wa.me/${wa}" target="_blank">Chat</a>` : ''
            ];
          });

          // Sort by Batch asc, then Name A–Z
          rows.sort((a,b)=>{
            const Ab = parseInt(a[2]) || 0, Bb = parseInt(b[2]) || 0;
            if (Ab !== Bb) return Ab - Bb;
            return (a[1] || '').localeCompare(b[1] || '');
          });

          $('#contacts').DataTable({
            data: rows,
            destroy: true,
            columns: [
              { title: 'S.No' },
              { title: 'Name' },
              { title: 'MBBS Batch' },
              { title: 'Designation' },
              { title: 'Place of Work' },
              { title: 'Contact' },
              { title: 'WhatsApp' }
            ],
            paging: false,
            searching: true,
            ordering: true,
            responsive: true,
            language: {
              search: 'Universal Search:',
              searchPlaceholder: 'Search name, MBBS batch, designation, place of work, phone…'
            }
          });
        },
        error: function(err) {
          alert('Failed to load contacts: ' + (err?.message || err));
        }
      });
    }
  </script>
</body>
</html>